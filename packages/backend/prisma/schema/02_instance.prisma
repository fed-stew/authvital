// =============================================================================
// Instance Configuration & Super Admin
// =============================================================================

// =============================================================================
// SUPER ADMIN (System-Level)
// =============================================================================

model SuperAdmin {
  id String @id @default(cuid())

  // ═══════════════════════════════════════════════════════════════════════════
  // PROFILE SCOPE (OIDC Standard Claims) - Matches User model
  // ═══════════════════════════════════════════════════════════════════════════
  username    String? @unique // Unique handle (e.g., @janesmith)
  displayName String? @map("display_name") // Full display name (OIDC: name)
  givenName   String? @map("given_name") // First name
  familyName  String? @map("family_name") // Last name
  middleName  String? @map("middle_name") // Middle name(s)
  nickname    String? // Casual name or alias
  pictureUrl  String? @map("picture_url") // Profile picture URL
  website     String? // Personal/professional URL
  gender      String? // Gender identity
  birthdate   String? // YYYY-MM-DD format
  zoneinfo    String? // IANA timezone (e.g., America/New_York)
  locale      String? // Language/region (e.g., en-US)

  // ═══════════════════════════════════════════════════════════════════════════
  // EMAIL SCOPE (OIDC Standard Claims)
  // ═══════════════════════════════════════════════════════════════════════════
  email         String  @unique
  emailVerified Boolean @default(false) @map("email_verified")

  // ═══════════════════════════════════════════════════════════════════════════
  // PHONE SCOPE (OIDC Standard Claims)
  // ═══════════════════════════════════════════════════════════════════════════
  phone         String? // E.164 format (e.g., +12345678901)
  phoneVerified Boolean @default(false) @map("phone_verified")

  // ═══════════════════════════════════════════════════════════════════════════
  // ADMIN-SPECIFIC FIELDS
  // ═══════════════════════════════════════════════════════════════════════════
  passwordHash       String   @map("password_hash")
  isActive           Boolean   @default(true) @map("is_active")
  mustChangePassword Boolean   @default(false) @map("must_change_password")
  lastLoginAt        DateTime? @map("last_login_at")

  // ═══════════════════════════════════════════════════════════════════════════
  // MFA
  // ═══════════════════════════════════════════════════════════════════════════
  mfaEnabled     Boolean   @default(false) @map("mfa_enabled")
  mfaSecret      String?   @map("mfa_secret") // Encrypted TOTP secret
  mfaBackupCodes String[]  @default([]) @map("mfa_backup_codes") // Hashed backup codes
  mfaVerifiedAt  DateTime? @map("mfa_verified_at")

  // ═══════════════════════════════════════════════════════════════════════════
  // SSO LINKS (for future SSO admin login)
  // ═══════════════════════════════════════════════════════════════════════════
  ssoLinks AdminSsoLink[]

  // ═══════════════════════════════════════════════════════════════════════════
  // TIMESTAMPS
  // ═══════════════════════════════════════════════════════════════════════════
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([username])
  @@map("super_admins")
}

/// AdminSsoLink: Links SuperAdmin accounts to external SSO providers
model AdminSsoLink {
  id            String   @id @default(cuid())
  adminId       String   @map("admin_id")
  admin         SuperAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)
  provider      String   // 'google' | 'microsoft' | etc.
  providerUserId String  @map("provider_user_id") // External user ID from provider
  email         String   // Email from SSO provider (for reference)
  rawProfile    Json?    @map("raw_profile") // Full profile from provider
  linkedAt      DateTime @default(now()) @map("linked_at")
  lastUsedAt    DateTime? @map("last_used_at")

  @@unique([provider, providerUserId])
  @@unique([adminId, provider])
  @@index([adminId])
  @@map("admin_sso_links")
}

// =============================================================================
// INSTANCE CONFIGURATION (Singleton)
// =============================================================================

/// InstanceMeta: Singleton configuration for this IDP instance
/// Enforced as singleton by using fixed id="instance"
model InstanceMeta {
  id           String @id @default("instance") // Singleton enforcement
  instanceUuid String @unique @default(uuid()) @map("instance_uuid") // Immutable fleet identifier
  name         String @default("AuthVital IDP")

  // Sign-up configuration (migrated from Directory)
  allowSignUp          Boolean  @default(false) @map("allow_sign_up")
  autoCreateTenant     Boolean  @default(true) @map("auto_create_tenant")
  allowGenericDomains  Boolean  @default(true) @map("allow_generic_domains")
  allowAnonymousSignUp Boolean  @default(false) @map("allow_anonymous_sign_up")
  requiredUserFields   String[] @default([]) @map("required_user_fields")
  defaultTenantRoleIds String[] @default([]) @map("default_tenant_role_ids")

  // ==========================================================================
  // SINGLE-TENANT MODE
  // ==========================================================================
  // When enabled, ALL signups auto-join the specified tenant
  // No tenant creation, no tenant picker - just one tenant for the whole IDP
  singleTenantMode Boolean @default(false) @map("single_tenant_mode")
  defaultTenantId  String? @map("default_tenant_id")

  // Default Branding (migrated from Directory)
  brandingName            String? @map("branding_name")
  brandingLogoUrl         String? @map("branding_logo_url")
  brandingIconUrl         String? @map("branding_icon_url")
  brandingPrimaryColor    String? @map("branding_primary_color")
  brandingBackgroundColor String? @map("branding_background_color")
  brandingAccentColor     String? @map("branding_accent_color")
  brandingSupportUrl      String? @map("branding_support_url")
  brandingPrivacyUrl      String? @map("branding_privacy_url")
  brandingTermsUrl        String? @map("branding_terms_url")
  initiateLoginUri        String? @map("initiate_login_uri")

  superAdminMfaRequired Boolean @default(false) @map("super_admin_mfa_required")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("instance_meta")
}

/// InstanceApiKey: API keys for instance-level operations (Fleet Manager)
/// These keys bypass tenant restrictions and can manage the entire instance
model InstanceApiKey {
  id          String    @id @default(cuid())
  keyHash     String    @map("key_hash") // Bcrypt hash of the full key
  prefix      String // First 8 chars for display (e.g., "ik_live_")
  name        String // User-friendly label
  description String? // Extended description
  permissions String[]  @default(["instance:*"]) // Instance-level permissions
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([prefix])
  @@map("instance_api_keys")
}
