// =============================================================================
// Core Identity Models
// =============================================================================

/// User: Individual identity within the instance
/// Can be a human user or a machine/service account
model User {
  id String @id @default(uuid())

  // ═══════════════════════════════════════════════════════════════════════════
  // PROFILE SCOPE (OIDC Standard Claims)
  // ═══════════════════════════════════════════════════════════════════════════
  username    String? @unique // Unique handle (e.g., @janesmith)
  displayName String? @map("display_name") // Full display name (OIDC: name)
  givenName   String? @map("given_name") // First name
  familyName  String? @map("family_name") // Last name
  middleName  String? @map("middle_name") // Middle name(s)
  nickname    String? // Casual name or alias
  pictureUrl  String? @map("picture_url") // Profile picture URL
  website     String? // Personal/professional URL
  gender      String? // Gender identity
  birthdate   String? // YYYY-MM-DD format
  zoneinfo    String? // IANA timezone (e.g., America/New_York)
  locale      String? // Language/region (e.g., en-US)

  // ═══════════════════════════════════════════════════════════════════════════
  // EMAIL SCOPE (OIDC Standard Claims)
  // ═══════════════════════════════════════════════════════════════════════════
  email         String? @unique // Email address
  emailVerified Boolean @default(false) @map("email_verified")

  // ═══════════════════════════════════════════════════════════════════════════
  // PHONE SCOPE (OIDC Standard Claims)
  // ═══════════════════════════════════════════════════════════════════════════
  phone         String? @unique // E.164 format (e.g., +12345678901)
  phoneVerified Boolean @default(false) @map("phone_verified")

  // ═══════════════════════════════════════════════════════════════════════════
  // AUTHENTICATION & ACCOUNT STATUS
  // ═══════════════════════════════════════════════════════════════════════════
  passwordHash   String?   @map("password_hash") // Null for machine users or passwordless
  mfaEnabled     Boolean   @default(false) @map("mfa_enabled") // Multi-factor authentication enabled
  mfaSecret      String?   @map("mfa_secret") // Encrypted TOTP secret
  mfaBackupCodes String[]  @default([]) @map("mfa_backup_codes") // Hashed backup codes
  mfaVerifiedAt  DateTime? @map("mfa_verified_at")
  isMachine      Boolean   @default(false) @map("is_machine") // True for service accounts
  isAnonymous    Boolean   @default(false) @map("is_anonymous") // True for anonymous accounts

  // ═══════════════════════════════════════════════════════════════════════════
  // PASSWORD RESET
  // ═══════════════════════════════════════════════════════════════════════════
  passwordResetToken   String?   @map("password_reset_token") // Bcrypt hash of reset token
  passwordResetExpires DateTime? @map("password_reset_expires") // Token expiry

  // ═══════════════════════════════════════════════════════════════════════════
  // TIMESTAMPS
  // ═══════════════════════════════════════════════════════════════════════════
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ═══════════════════════════════════════════════════════════════════════════
  // RELATIONS
  // ═══════════════════════════════════════════════════════════════════════════
  memberships         Membership[]
  sessions            Session[]
  authorizationCodes  AuthorizationCode[]
  refreshTokens       RefreshToken[]
  apiKeys             ApiKey[]
  invitationsSent     Invitation[]        @relation("InvitationsSent")
  invitationsReceived Invitation[]        @relation("InvitationsReceived")
  licenseAssignments  LicenseAssignment[]
  appAccess           AppAccess[]
  ssoLinks            UserSsoLink[]

  @@index([isMachine])
  @@index([username])
  @@map("users")
}

/// ApiKey: User-generated API keys for programmatic access
model ApiKey {
  id          String    @id @default(cuid())
  keyHash     String    @map("key_hash") // Bcrypt hash of the full key
  prefix      String // First 8 chars for display (e.g., "sk_live_a1b2")
  name        String // User-friendly label
  description String? // Extended description (e.g., "Used for nightly sync")
  permissions String[] // List of permission strings
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at") // Optional expiration
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([prefix])
  @@index([userId])
  @@map("api_keys")
}

/// Session: User login session (cookie-based)
model Session {
  id        String   @id @default(cuid())
  token     String   @unique @default(uuid())
  userAgent String?  @map("user_agent")
  ipAddress String?  @map("ip_address")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}
